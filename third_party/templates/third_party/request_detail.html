<!-- templates/third_party/request_detail.html -->
{% extends 'base_app.html' %}

{% block page_container %}
  <div class="page-narrow-left">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h5 mb-0">Third-party Request</h1>
    </div>

    <!-- Workflow status bar -->
    {% include 'third_party/_workflow_status.html' with object=object %}

    <!-- Summary + meta -->
    <div class="card mb-3 shadow-sm">
      <div class="card-body p-4">

        <div class="d-flex justify-content-between align-items-start mb-2">
            <h2>{{ object.get_state_display }}</h2>
        </div>

        <div class="d-flex justify-content-between align-items-start">
          <h2 class="h6 mb-0">{{ object.name }}</h2>

        </div>

        <p class="mt-2 mb-0 text-secondary">{{ object.description|default:'—' }}</p>

        <!-- Read-only fields row -->
          <div class="row g-3 mt-2">
            <div class="col-sm-6">
              <label class="form-label">Assigned to</label>
              <input type="text" class="form-control" readonly
                    value="{% if object.assignee %}{{ object.assignee.get_full_name|default:object.assignee.email|default:object.assignee.username }}{% else %}Unassigned{% endif %}">
            </div>

            <div class="col-sm-6">
              <label class="form-label">Created by</label>
              <input type="text" class="form-control" readonly
                    value="{% if object.created_by %}{{ object.created_by.get_full_name|default:object.created_by.email|default:object.created_by.username }}{% else %}—{% endif %}">
            </div>

            <div class="col-sm-6">
              <label class="form-label">Created at</label>
              <input type="text" class="form-control" readonly value="{{ object.created_at|date:'Y-m-d H:i' }}">
            </div>

            <div class="col-sm-6">
              <label class="form-label">Status</label>
              <input type="text" class="form-control" readonly value="{{ object.get_state_display }}">
            </div>
          </div>

      </div>
    </div>

    <!-- ACTIONS: use can_transition passed from the view -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-wrap gap-2">
        {% if object.state == "ONBOARDING" %}
          <form method="post" action="{% url 'third_party:request_submit' object.pk %}">
            {% csrf_token %}
            <button class="btn btn-primary btn-sm"
                    {% if not can_transition %}disabled data-bs-toggle="tooltip" data-bs-title="Only the assignee or staff can transition."{% endif %}>
              <i class="bi bi-send"></i> Submit for review
            </button>
          </form>
          <button class="btn btn-outline-danger btn-sm"
                  data-bs-toggle="modal" data-bs-target="#rejectModal"
                  {% if not can_transition %}disabled data-bs-toggle="tooltip" data-bs-title="Only the assignee or staff can transition."{% endif %}>
            <i class="bi bi-x-octagon"></i> Reject
          </button>

        {% elif object.state == "REVIEW" %}
          <form method="post" action="{% url 'third_party:request_approve' object.pk %}">
            {% csrf_token %}
            <button class="btn btn-success btn-sm"
                    {% if not can_transition %}disabled data-bs-toggle="tooltip" data-bs-title="Only the assignee or staff can transition."{% endif %}>
              <i class="bi bi-patch-check"></i> Approve
            </button>
          </form>
          <button class="btn btn-outline-danger btn-sm"
                  data-bs-toggle="modal" data-bs-target="#rejectModal"
                  {% if not can_transition %}disabled data-bs-toggle="tooltip" data-bs-title="Only the assignee or staff can transition."{% endif %}>
            <i class="bi bi-x-octagon"></i> Reject
          </button>

        {% elif object.state == "APPROVED" %}
          <span class="text-success"><i class="bi bi-check2-circle"></i> Approved — no further actions</span>

        {% elif object.state == "REJECTED" %}
          <span class="text-danger"><i class="bi bi-x-octagon-fill"></i> Rejected</span>
        {% endif %}
      </div>
    </div>

    <!-- Reject Modal (POST with reason) -->
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" method="post" action="{% url 'third_party:request_reject' object.pk %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="rejectModalLabel">Reject request</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label for="rejectReason" class="form-label">Reason (required)</label>
            <textarea id="rejectReason" name="reason" rows="3" class="form-control" required></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">
              <i class="bi bi-x-octagon"></i> Reject
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Audit Log -->
    <div class="card">
      <div class="card-header bg-white">
        <strong><i class="bi bi-clock-history"></i> Audit Log</strong>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>When</th>
                <th>By</th>
                <th>From → To</th>
                <th>Description</th>
              </tr>
            </thead>

            <tbody>
              {% for log in logs %}
                <tr>
                  <td class="text-nowrap">{{ log.timestamp|date:"Y-m-d H:i" }}</td>
                  <td>
                    {% if log.by %}
                      {{ log.by.get_full_name|default:log.by.email|default:log.by.username }}
                    {% else %}
                      <span class="text-body-secondary">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge text-bg-light border-soft">{{ log.source_state|default:"—" }}</span>
                    <i class="bi bi-arrow-right-short"></i>
                    <span class="badge text-bg-light border-soft">{{ log.state|default:"—" }}</span>
                  </td>
                  <td>{{ log.description|default:"—" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-body-secondary py-3">No transitions yet.</td>
                </tr>
              {% endfor %}
            </tbody>


          </table>
        </div>
      </div>
    </div>

  </div>
{% endblock %}
